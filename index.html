<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Крен и дифферент</title>
<meta name="theme-color" content="#0b0f14"/>
<link rel="manifest" href="manifest.webmanifest">
<style>
:root{--bg:#0b0f14;--card:#121a23;--muted:#9bb0c6;--text:#eaf2ff;--line:#223244;--good:#39d98a;--bad:#ff5c7a;--warn:#ffd166;--btn:#1f2c3b;--btn2:#27384c;--mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--sans:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
*{box-sizing:border-box} body{margin:0;font-family:var(--sans);background:var(--bg);color:var(--text);}
header{position:sticky;top:0;z-index:9;background:rgba(11,15,20,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);}
.wrap{max-width:900px;margin:0 auto;padding:14px 14px 24px;}
.topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;}
.tabs{display:flex;gap:10px;flex-wrap:wrap;}
.tabbtn{border:1px solid var(--line);background:var(--btn);color:var(--text);padding:10px 12px;border-radius:12px;font-weight:650;cursor:pointer;}
.tabbtn.active{background:var(--btn2);border-color:#2f4763;}
.pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:13px;}
.grid{display:grid;gap:12px;}
@media(min-width:760px){.grid.cols2{grid-template-columns:1fr 1fr;}}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;}
.h{font-size:14px;color:var(--muted);margin:0 0 8px 0;}
.big{font-size:42px;line-height:1;font-weight:800;letter-spacing:-0.02em;font-family:var(--mono);}
.sub{color:var(--muted);font-size:14px;margin-top:8px;}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
.btn{border:1px solid var(--line);background:var(--btn);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:650;}
.btn.primary{background:#22364d;border-color:#2f4763;}
.btn.danger{background:#3a1c26;border-color:#5a2a3a;}
.btn:disabled{opacity:.55;cursor:not-allowed;}
.kv{display:grid;grid-template-columns:1fr auto;gap:8px 10px;align-items:center;font-size:14px;}
.kv .k{color:var(--muted);} .kv .v{font-family:var(--mono);}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;}
input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0d141d;color:var(--text);font-family:var(--mono);font-size:14px;outline:none;}
.hint{color:var(--muted);font-size:12px;line-height:1.35;}
.chk{display:flex;gap:10px;align-items:flex-start;margin:8px 0;color:var(--text);font-size:14px}
.chk input{margin-top:3px;transform:scale(1.15)}
.status{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;border:1px solid var(--line);background:#0d141d;color:var(--muted);font-size:13px;}
.dot{width:10px;height:10px;border-radius:50%;}
.dot.good{background:var(--good);} .dot.bad{background:var(--bad);} .dot.warn{background:var(--warn);}
.mono{font-family:var(--mono);} .hidden{display:none;}
.footerNote{margin-top:10px;font-size:12px;color:var(--muted);} .hr{height:1px;background:var(--line);margin:12px 0;}
</style>
</head>
<body>
<header><div class="wrap"><div class="topbar">
  <div class="tabs">
    <button class="tabbtn active" id="tabMeasure">Измерение</button>
    <button class="tabbtn" id="tabSettings">Настройки</button>
  </div>
  <div class="pill">Работает офлайн после установки</div>
</div></div></header>

<main class="wrap">
<section id="pageMeasure" class="grid cols2">
  <div class="card">
    <p class="h">Крен (градусы)</p>
    <div class="big" id="heelBig">—</div>
    <div class="sub">Большие цифры — среднее. Ниже — текущее и разброс.</div>
    <div class="hr"></div>
    <div class="kv">
      <div class="k">Текущее</div><div class="v" id="heelNow">—</div>
<div class="k">Разброс (σ)</div><div class="v" id="heelStd">—</div>
    </div>
  </div>

  <div class="card">
    <p class="h">Дифферент (метры)</p>
    <div class="big" id="trimBig">—</div>
    <div class="sub" id="trimSub">—</div>
    <div class="hr"></div>
    <div class="kv">
      <div class="k">Текущее (м)</div><div class="v" id="trimNow">—</div>
<div class="k">Разброс (σ, °)</div><div class="v" id="trimStd">—</div>
    </div>
  </div>

  <div class="card">
    <p class="h">Управление</p>
    <div class="row">
      <button class="btn primary" id="btnStart">Запустить датчики</button>
      <button class="btn" id="btnStop" disabled>Остановить</button>
      <button class="btn" id="btnHold">Зафиксировать</button>
      <button class="btn danger" id="btnClearHold">Сброс фиксации</button>
    </div>
    <div style="height:10px"></div>
    <div class="row">
      <span class="status" id="stState"><span class="dot warn"></span><span id="stText">Ожидание</span></span>
      <span class="status"><span class="mono">Окно:</span>&nbsp;<span class="mono" id="avgWindowLabel">30 c</span></span>
      <span class="status"><span class="mono">Режим:</span>&nbsp;<span class="mono" id="modeLabel">С ОПОРОЙ</span></span>
    </div>
    <div class="footerNote">
      Если датчики не работают в Chrome из файла (file://), это ограничение браузера. В HTTPS/PWA — работают.
    </div>
  </div>
</section>

<section id="pageSettings" class="hidden">
  <div class="grid cols2">
    <div class="card">
      <p class="h">Геометрия (метры)</p>
      <div class="grid cols2">
        <div>
          <label for="dStern">До кормы от точки измерения</label>
          <input id="dStern" type="number" step="0.1" min="0" placeholder="25.0">
        </div>
        <div>
          <label for="dBow">До носа (бака) от точки измерения</label>
          <input id="dBow" type="number" step="0.1" min="0" placeholder="195.0">
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="kv">
        <div class="k">Длина (расчётная)</div><div class="v" id="lenCalc">—</div>
      </div>
      <div class="hint" style="margin-top:10px;">
        Дифферент в метрах: <span class="mono">ΔH = L · tan(θ)</span>, где <span class="mono">L = dкорма + dнос</span>.
      </div>
    </div>

    <div class="card">
      <p class="h">Опора (то, что известно точно)</p>
      <div class="grid cols2">
        <div>
          <label for="trimRefM">Опорный дифферент, м</label>
          <input id="trimRefM" type="number" step="0.01" placeholder="2.00">
        </div>
        <div>
          <label for="heelRefDeg">Опорный крен, °</label>
          <input id="heelRefDeg" type="number" step="0.01" placeholder="1.00">
        </div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn primary" id="btnSetBaseTrim">Задать базу дифферента (по текущему)</button>
        <button class="btn primary" id="btnSetBaseHeel">Задать базу крена (по текущему)</button>
      </div>
      <div style="height:10px"></div>
      <div class="kv">
        <div class="k">База дифферента (θ₀), °</div><div class="v" id="baseTrimDeg">—</div>
        <div class="k">База крена (φ₀), °</div><div class="v" id="baseHeelDeg">—</div>
      </div>
    </div>

    <div class="card">
      <p class="h">Усреднение и режим</p>
      <div class="grid cols2">
        <div>
          <label for="mode">Режим</label>
          <select id="mode">
            <option value="ref">С ОПОРОЙ</option>
            <option value="abs">БЕЗ ОПОРЫ</option>
          </select>
        </div>
        <div>
          <label for="avgWindow">Окно среднего, секунд</label>
          <select id="avgWindow">
            <option value="10">10</option>
            <option value="30" selected>30</option>
            <option value="60">60</option>
          </select>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="grid cols2">
        <div>
          <label for="stableStdDeg">Порог “стабильно”, σ (°)</label>
          <input id="stableStdDeg" type="number" step="0.01" min="0" placeholder="0.05">
          <div class="hint" style="margin-top:6px;">Рекомендуемо для стола: 0.03–0.08°</div>
        </div>
        <div>
          <label>Оси и направления</label>
          <div class="hint" style="margin-top:6px;">Настраивается один раз для вашего упора/стола.</div>
          <div style="height:8px"></div>
          <label class="chk"><input id="swapXY" type="checkbox"> Поменять оси X↔Y (крен ↔ дифферент)</label>
          <label class="chk"><input id="invHeel" type="checkbox"> Инвертировать крен (лево/право)</label>
          <label class="chk"><input id="invTrim" type="checkbox"> Инвертировать дифферент (нос/корма)</label>
          <div class="hint" style="margin-top:6px;">Подсказка знаков: крен + = направо, − = налево. Дифферент + = на корму, − = на нос.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <p class="h">Сохранение</p>
      <div class="row">
        <button class="btn primary" id="btnSave">Сохранить</button>
        <button class="btn danger" id="btnReset">Сбросить</button>
      </div>
      <div class="footerNote" id="saveState">Настройки ещё не сохранены.</div>
    </div>
  </div>
</section>
</main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const deg = (rad) => rad * 180 / Math.PI;
  const rad = (deg) => deg * Math.PI / 180;
  const fmt = (v, n=2) => (Number.isFinite(v) ? v.toFixed(n) : "—");
  const mean = (arr)=>arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:NaN;
  const std = (arr)=>{
    if(arr.length<2) return NaN;
    const m=mean(arr); let s=0; for(const x of arr) s+=(x-m)*(x-m);
    return Math.sqrt(s/(arr.length-1));
  };

  // tabs
  const tabMeasure=$("tabMeasure"), tabSettings=$("tabSettings");
  const pageMeasure=$("pageMeasure"), pageSettings=$("pageSettings");
  function show(which){
    const isM = which==="m";
    tabMeasure.classList.toggle("active", isM);
    tabSettings.classList.toggle("active", !isM);
    pageMeasure.classList.toggle("hidden", !isM);
    pageSettings.classList.toggle("hidden", isM);
  }
  tabMeasure.onclick=()=>show("m");
  tabSettings.onclick=()=>show("s");

  const KEY="ship_inclino_pwa_v1";
  const DEF={dStern:25,dBow:195,trimRefM:2,heelRefDeg:1,baseTrimDeg:0,baseHeelDeg:0,mode:"ref",avgWindowSec:30,stableStdDeg:0.05,swapXY:false,invHeel:false,invTrim:false};
  let S={...DEF};

  function syncUI(){
    $("dStern").value=S.dStern;
    $("dBow").value=S.dBow;
    $("trimRefM").value=S.trimRefM;
    $("heelRefDeg").value=S.heelRefDeg;
    $("mode").value=S.mode;
    $("avgWindow").value=String(S.avgWindowSec);
    $("stableStdDeg").value=S.stableStdDeg;
    $("swapXY").checked=!!S.swapXY; $("invHeel").checked=!!S.invHeel; $("invTrim").checked=!!S.invTrim;
    $("baseTrimDeg").textContent=fmt(S.baseTrimDeg,3);
    $("baseHeelDeg").textContent=fmt(S.baseHeelDeg,3);
    updateDerived();
    updateLabels();
  }
  function readUI(){
    S.dStern=Number($("dStern").value||0);
    S.dBow=Number($("dBow").value||0);
    S.trimRefM=Number($("trimRefM").value||0);
    S.heelRefDeg=Number($("heelRefDeg").value||0);
    S.mode=$("mode").value;
    S.avgWindowSec=Number($("avgWindow").value||30);
    S.stableStdDeg=Number($("stableStdDeg").value||0.05);
    S.swapXY=$("swapXY").checked; S.invHeel=$("invHeel").checked; S.invTrim=$("invTrim").checked;
  }
  function save(){
    readUI();
    localStorage.setItem(KEY, JSON.stringify(S));
    $("saveState").textContent="Сохранено.";
    updateDerived(); updateLabels();
  }
  function reset(){
    localStorage.removeItem(KEY);
    S={...DEF};
    syncUI();
    $("saveState").textContent="Сброшено.";
  }
  $("btnSave").onclick=save;
  $("btnReset").onclick=reset;

  function load(){
    try{ const raw=localStorage.getItem(KEY); if(raw) S={...DEF,...JSON.parse(raw)}; }catch(e){}
    syncUI();
  }

  function updateDerived(){
    readUI();
    const L=S.dStern+S.dBow;
    $("lenCalc").textContent=fmt(L,1)+" м";
    $("trimSub").textContent="Длина: "+fmt(L,1)+" м";
  }
  function updateLabels(){
    $("avgWindowLabel").textContent=S.avgWindowSec+" c";
    $("modeLabel").textContent=(S.mode==="ref")?"С ОПОРОЙ":"БЕЗ ОПОРЫ";
  }
  ["dStern","dBow","mode","avgWindow","stableStdDeg","swapXY","invHeel","invTrim","trimRefM","heelRefDeg"].forEach(id=>{
    $(id).addEventListener("input", ()=>{ updateDerived(); updateLabels(); });
    $(id).addEventListener("change", ()=>{ updateDerived(); updateLabels(); });
  });

  // measurement
  let running=false;
  let lastRoll=NaN, lastPitch=NaN;
  let rollEma=NaN, pitchEma=NaN;
  const EMA_ALPHA=0.08;
  let buf=[]; // {t, r, p}
  const btnStart=$("btnStart"), btnStop=$("btnStop");
  let hold=null;

  function setStatus(kind,text){
    const st=$("stState");
    const dot=st.querySelector(".dot");
    dot.classList.remove("good","bad","warn");
    dot.classList.add(kind);
    $("stText").textContent=text;
  }

  async function requestPermission(){
    try{
      if(typeof DeviceMotionEvent!=="undefined" && typeof DeviceMotionEvent.requestPermission==="function"){
        const res=await DeviceMotionEvent.requestPermission();
        return res==="granted";
      }
      return true;
    }catch(e){ return false; }
  }

  function start(){
    if(running) return;
    readUI(); updateLabels(); updateDerived();
    running=true;
    btnStart.disabled=true; btnStop.disabled=false;
    window.addEventListener("devicemotion", onMotion, {passive:true});
    setStatus("warn","Сбор данных…");
  }
  function stop(){
    if(!running) return;
    running=false;
    btnStart.disabled=false; btnStop.disabled=true;
    window.removeEventListener("devicemotion", onMotion);
    setStatus("warn","Остановлено");
  }

  btnStart.onclick=async ()=>{
    const ok=await requestPermission();
    if(!ok){ alert("Нет доступа к датчикам."); return; }
    start();
  };
  btnStop.onclick=stop;

  $("btnHold").onclick=()=>{
    if(!Number.isFinite(lastRoll)||!Number.isFinite(lastPitch)) { alert("Нет данных."); return; }
    const out=compute();
    hold={heel:out.heelNow, trim:out.trimNow, sigH:out.sigH, sigP:out.sigP, t:Date.now()};
    render();
  };
  $("btnClearHold").onclick=()=>{ hold=null; render(); };

  $("btnSetBaseTrim").onclick=()=>{
    if(!Number.isFinite(lastPitch)) { alert("Сначала запусти датчики."); return; }
    S.baseTrimDeg=lastPitch;
    $("baseTrimDeg").textContent=fmt(S.baseTrimDeg,3);
    $("saveState").textContent="База дифферента задана. Нажми «Сохранить».";
  };
  $("btnSetBaseHeel").onclick=()=>{
    if(!Number.isFinite(lastRoll)) { alert("Сначала запусти датчики."); return; }
    S.baseHeelDeg=lastRoll;
    $("baseHeelDeg").textContent=fmt(S.baseHeelDeg,3);
    $("saveState").textContent="База крена задана. Нажми «Сохранить».";
  };

  function onMotion(e){
    const a=e.accelerationIncludingGravity;
    if(!a) return;
    let ax=a.x, ay=a.y, az=a.z;
    if(![ax,ay,az].every(Number.isFinite)) return;

    if(S.swapXY){ const t=ax; ax=ay; ay=t; }

    let roll=deg(Math.atan2(ay, az));
    let pitch=deg(Math.atan2(-ax, Math.sqrt(ay*ay + az*az)));

    if(S.invTrim) pitch=-pitch;
    if(S.invHeel) roll=-roll;

    lastRoll=roll; lastPitch=pitch;

    rollEma=Number.isFinite(rollEma)?(rollEma*(1-EMA_ALPHA)+roll*EMA_ALPHA):roll;
    pitchEma=Number.isFinite(pitchEma)?(pitchEma*(1-EMA_ALPHA)+pitch*EMA_ALPHA):pitch;

    const now=Date.now();
    buf.push({t:now, r:rollEma, p:pitchEma});
    const T=S.avgWindowSec*1000;
    while(buf.length && (now-buf[0].t)>T) buf.shift();

    render();
  }

  function signTrim(m){ return m>0?"НА КОРМУ":(m<0?"НА НОС":""); }
  function signHeel(d){ return d>0?"НАПРАВО":(d<0?"НАЛЕВО":""); }

  function compute(){
    const rolls=buf.map(x=>x.r);
    const pitchs=buf.map(x=>x.p);
    const rAvg=mean(rolls), pAvg=mean(pitchs);
    const rStd=std(rolls), pStd=std(pitchs);

    const L=(Number(S.dStern)||0)+(Number(S.dBow)||0);
    const baseR=Number(S.baseHeelDeg)||0;
    const baseP=Number(S.baseTrimDeg)||0;

    let heelNow, heelAvg;
    if(S.mode==="ref"){
      heelNow=(Number(S.heelRefDeg)||0)+(rollEma-baseR);
      heelAvg=(Number(S.heelRefDeg)||0)+(rAvg-baseR);
    } else {
      heelNow=rollEma; heelAvg=rAvg;
    }

    let trimNow, trimAvg;
    if(!Number.isFinite(L)||L<=0){ trimNow=NaN; trimAvg=NaN; }
    else if(S.mode==="ref"){
      trimNow=(Number(S.trimRefM)||0)+L*Math.tan(rad(pitchEma-baseP));
      trimAvg=(Number(S.trimRefM)||0)+L*Math.tan(rad(pAvg-baseP));
    } else {
      trimNow=L*Math.tan(rad(pitchEma));
      trimAvg=L*Math.tan(rad(pAvg));
    }

    return {L, heelNow, heelAvg, sigH:rStd, sigP:pStd, trimNow, trimAvg};
  }

  function render(){
    const out=compute();

    const sigma=Number.isFinite(out.sigP)?out.sigP:Infinity;
    const th=Number(S.stableStdDeg)||0.05;
    if(!running) setStatus("warn","Остановлено");
    else if(!buf.length) setStatus("warn","Сбор данных…");
    else if(sigma<=th) setStatus("good","Стабильно");
    else if(sigma<=th*2.5) setStatus("warn","Почти стабильно");
    else setStatus("bad","Шатает / вибрация");

    const heelShow=hold?hold.heel:out.heelAvg;
    const trimShow=hold?hold.trim:out.trimAvg;

    $("heelBig").textContent = `${fmt(heelShow,2)}° ${signHeel(heelShow)}`;
    $("trimBig").textContent = `${fmt(Math.abs(trimShow),2)} м ${signTrim(trimShow)}`;

    $("heelNow").textContent = fmt(out.heelNow,2)+"°";
    const _heelAvgEl=$("heelAvg"); if(_heelAvgEl) _heelAvgEl.textContent = fmt(out.heelAvg,2)+"°";
    $("heelStd").textContent = fmt(out.sigH,3)+"°";

    $("trimNow").textContent = fmt(out.trimNow,2)+" м";
    const _trimAvgEl=$("trimAvg"); if(_trimAvgEl) _trimAvgEl.textContent = fmt(out.trimAvg,2)+" м";
    $("trimStd").textContent = fmt(out.sigP,3)+"°";

    $("trimSub").textContent = "Длина: "+fmt(out.L,1)+" м";
  }

  // register service worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }

  load();
  render();
})();
</script>
</body>
</html>
